# Oke Creator - Web App ユーザーガイド

**FFmpeg + Demucs によるボーカル分離・キー変更ツール**  
テンポ維持、フォルマント考慮、48kHz対応の高機能Webアプリケーション

---

## 📋 目次

1. [前提要件](#前提要件)
2. [セットアップ](#セットアップ)
3. [起動方法](#起動方法)
4. [使い方](#使い方)
5. [できること](#できること)
6. [ファイル名書式](#ファイル名書式)
7. [トラブルシューティング](#トラブルシューティング)

---

## 前提要件

### システム要件
- **OS**: Windows 10 / 11 64-bit
- **Python**: 3.8 以上（推奨: 3.10 以上）
- **RAM**: 4GB 以上（推奨: 8GB 以上）
- **ディスク空き容量**: 10GB 以上

### インストール済みソフトウェア

#### 1. FFmpeg
- **配置先**: `F:\tools\ffmpeg\bin\` (推奨)
- **インストール確認**:
  ```powershell
  ffmpeg -version
  ```
- **環境変数 PATH** に `F:\tools\ffmpeg\bin` を追加済み

**ダウンロード**: https://ffmpeg.org/download.html

#### 2. Python 仮想環境
以下の手順で仮想環境をセットアップ済みであることが前提です：

```bash
cd C:\manabu\develop\python3\oke-creator
python -m venv .venv
```

#### 3. 必要なライブラリ
アプリ起動時に自動的にチェックされます：
- streamlit
- demucs
- torch
- pandas
- numpy

---

## セットアップ

### ステップ 1: 仮想環境の有効化

```bash
cd C:\manabu\develop\python3\oke-creator
.venv\Scripts\activate
```

プロンプトに `(.venv)` が表示されればOK。

### ステップ 2: 必要なライブラリをインストール

```bash
python -m pip install --upgrade pip
pip install -r src\requirements.txt
```

### ステップ 3: インストール確認

```bash
python -m demucs --help
ffmpeg -version
```

両方のコマンドが正常に実行されれば準備完了です。

---

## 起動方法

### 方法1: バッチファイルで起動（推奨）

```bash
.\run_app.bat
```

自動的に仮想環境を有効化し、Streamlitアプリを起動します。  
ブラウザで http://localhost:8501 に自動的に開きます。

### 方法2: 手動で起動

```bash
.venv\Scripts\activate
streamlit run src/app.py
```

ブラウザで http://localhost:8501 を開いてください。

### Streamlit の初回起動

初回起動時にメールアドレス入力を求められます：
- **スキップ**: Enterキーを押して空白のままにする（推奨）
- **入力**: メールアドレスを入力してEnter

---

## 使い方

### 🎤 Tab 1: ボーカル分離

ボーカル分離はDemucsを使用して、入力ファイルをVocals（ボーカル）とNo Vocals（カラオケ）に分離します。

#### 手順

1. **ファイル選択**
   - 「分離する音声ファイルを選択」から `C:\Users\manab\Downloads\` 配下の .mp3 または .m4a ファイルを選択
   - ファイル情報（名前、サイズ、保存先）が表示されます

2. **Demucs 実行**
   - 「🚀 Demucs で分離を実行」ボタンをクリック
   - 処理中ダイアログが表示されます
   - 曲の長さにより数分～十数分かかる場合があります

3. **完了**
   - 分離完了時に成功メッセージが表示されます
   - `C:\manabu\temp\htdemucs\曲名\` に以下が生成されます:
     - `vocals.wav` - ボーカルのみ
     - `no_vocals.wav` - ボーカル除外（カラオケ）

#### ⏱️ 処理時間目安

| 曲の長さ | 処理時間 |
|---------|---------|
| 3分     | 1-2分   |
| 5分     | 2-3分   |
| 10分    | 4-6分   |

※CPU性能とメモリ容量により変動します

---

### 🎵 Tab 2: キー変更・48kHz WAV変換

分離済みファイルに対して、キー変更やサンプルレート変換を実行します。

#### 手順

**1. 曲を選択**
- 「処理する曲を選択（分離済みから）」で分離済みの曲を選択
- `C:\manabu\temp\htdemucs\` 配下から自動検出されます

**2. 処理ファイルを選択**
- ラジオボタンで以下から選択:
  - 🎤 **Vocals** - ボーカルのみ
  - 🎵 **No Vocals** - カラオケ（ボーカル除外）
  - 📌 **Original** - Step 1前の元ファイル（.mp3/.m4a）

**3. 処理設定**

| 項目 | 説明 | 範囲 | デフォルト |
|------|------|------|---------|
| キー変更 | 半音単位で調整 | -3～+3 | 0（変更なし） |
| フォルマント考慮 | ボーカルの声質保持 | チェック/未チェック | Vocals選択時のみON |
| 出力フォーマット | サンプルレート | 44.1kHz / 48kHz | 44.1kHz |

**4. ファイル名設定**

自動生成されたファイル名が表示されます：
- 書式: `曲名_種類_キー数字_kHz_v番号.wav`
- 例: `Feel_Special_novocals_-3_48kHz_v1.wav`

必要に応じて手動編集可能です。

**5. ファイル名を再調整**

キーやバージョン番号を変更後、「🔄 再調整」ボタンを押すとオリジナルフォーマットにリセットされます。

**6. 実行**

「🚀 キー変更・変換を実行」ボタンをクリック：
- 実行予定のFFmpegコマンドが表示されます
- 「実行」で処理を開始
- 処理中ダイアログが表示されます
- 完了時に成功メッセージと出力ファイル情報が表示されます

---

## できること

### ✅ 主な機能

| 機能 | 説明 | 対応フォーマット |
|------|------|---------|
| **ボーカル分離** | Demucsを使用してVocals/No Vocalsに分離 | .mp3, .m4a, .wav |
| **キー変更** | -3～+3の半音単位で調整 | .wav |
| **テンポ維持** | ruberbandフィルタでテンポ変化なし | - |
| **フォルマント考慮** | ボーカルの声質を保持 | .wav (Vocals) |
| **48kHz WAV出力** | ダンス本番・PA向けの高品質出力 | - |
| **コマンド表示** | 実行するFFmpegコマンドを事前表示 | - |

### ✅ 出力可能な形式

- **44.1kHz WAV** - 標準的な音声編集用途
- **48kHz WAV** - ダンス本番、PA、映像制作向け

### ✅ キー変更対応範囲

| 半音 | Pitch倍率 | 用途 |
|------|-----------|------|
| -3   | 0.840896  | 女性キー → 標準キー |
| -2   | 0.890899  | やや低め |
| -1   | 0.943874  | 1半音下げ |
| 0    | 1.0       | 原曲のまま |
| +1   | 1.059463  | 1半音上げ |
| +2   | 1.122462  | やや高め |
| +3   | 1.189207  | 標準キー → 女性キー |

---

## ファイル名書式

### 生成されるファイル名の形式

```
曲名_種類_キー数字_kHz_v番号.wav
```

### 各要素の説明

| 要素 | 説明 | 例 |
|------|------|------|
| 曲名 | 元のファイル名（拡張子除外） | `Feel_Special` |
| 種類 | 処理ファイルの種類 | `vocals`, `novocals`, `original` |
| キー数字 | キー変更（-3～+3） | `-3`, `0`, `+2` |
| kHz | サンプルレート | `44kHz`, `48kHz` |
| v番号 | バージョン番号（1～99） | `v1`, `v5`, `v10` |

### 実例

```
Feel_Special_novocals_-3_48kHz_v1.wav
↑             ↑        ↑  ↑     ↑
曲名          種類     キー Hz   版
```

### カスタマイズ

「出力ファイル名（拡張子除外）」のテキストボックスで自由に編集可能です。  
編集後は「🔄 再調整」ボタンで、パラメータに基づいた形式に戻せます。

---

## トラブルシューティング

### ❌ Demucsが起動しない

**確認項目:**
```bash
python -m demucs --help
```

**対処:**
```bash
pip install --upgrade demucs
```

### ❌ FFmpegコマンドが実行されない

**確認:**
```powershell
ffmpeg -version
```

**対処:**
- `F:\tools\ffmpeg\bin` に ffmpeg.exe があるか確認
- 環境変数 PATH に上記パスが追加されているか確認
- コマンドプロンプトを再起動

### ❌ Streamlitが起動しない

**対処:**
```bash
pip install --upgrade streamlit
streamlit run src/app.py
```

### ❌ 処理がタイムアウトする

**原因:** CPU やメモリが足りない可能性

**対処:**
- 他のアプリケーションを閉じる
- より短い曲で試す
- メモリを増設または他の処理を終了

### ❌ ファイルが見つからないエラー

**確認:**
- ダウンロードフォルダのパス: `C:\Users\manab\Downloads\`
- 作業フォルダのパス: `C:\manabu\temp\htdemucs\`
- パスが存在しない場合は手動で作成

### ❌ 「元ファイル（Original）」が検出されない

**原因:** ダウンロードフォルダに該当ファイルがない

**対処:**
- 曲名で検索して、ダウンロードフォルダにコピー
- ファイル名の曲名部分が一致していることを確認

---

## 📁 ファイル・フォルダ構成

```
oke-creator/
├── src/
│   ├── app.py                 # Streamlit Webアプリのメイン
│   ├── config.py              # 設定・pitch倍率テーブル
│   ├── requirements.txt        # 依存パッケージ
│   ├── README.md              # Src内のドキュメント
│   └── utils/
│       ├── __init__.py
│       ├── audio_utils.py     # Demucs分離実行
│       └── ffmpeg_utils.py    # FFmpeg実行
├── run_app.bat                # アプリ起動バッチ
├── .venv/                     # Python仮想環境
├── ReadMe.md                  # 技術ノート
└── README2.md                 # このファイル（ユーザーガイド）
```

### 出力フォルダ

```
C:\manabu\temp\htdemucs\
└── 曲名/
    ├── vocals.wav             # ボーカル
    ├── no_vocals.wav          # カラオケ
    └── [処理済みWAV]          # キー変更後のファイル
```

---

## 💡 ベストプラクティス

### ✅ 推奨される使い方

- **ボーカルの処理**:
  - フォルマント考慮（✓）を有効化して声質を保持
  
- **ダンス本番向け**:
  - 48kHz WAV で出力
  - 高品質なPA接続対応

- **複数バージョン管理**:
  - バージョン番号（v1, v2, ...）で管理
  - 同じ曲の異なるキーを整理

- **元ファイルの保護**:
  - 元ファイルは編集せず、Original 処理で処理

### ❌ 避けるべき使い方

- ❌ Vocalファイルをフォルマント考慮なしで処理（声が不自然になる）
- ❌ 加工済みファイルの複数回処理（品質低下）
- ❌ 非対応フォーマットの直接処理（.flac, .oggなど）

---

## 🎯 使用例

### 例1: カラオケ音源の作成（キー-3、48kHz）

1. **Tab 1** で曲ファイルを選択して分離実行
   - `Feel_Special.m4a` を分離
   - `vocals.wav`, `no_vocals.wav` 生成

2. **Tab 2** で:
   - 曲: `Feel_Special` を選択
   - ファイル: `No Vocals` を選択
   - キー変更: `-3` に設定
   - 出力フォーマット: `48kHz WAV` を選択
   - バージョン: `1` に設定
   - 「🚀 キー変更・変換を実行」

3. 出力:
   - `Feel_Special_novocals_-3_48kHz_v1.wav` が生成

### 例2: ボーカル抽出（オリジナルキー、フォルマント考慮）

1. **Tab 1** で曲を分離

2. **Tab 2** で:
   - ファイル: `Vocals` を選択
   - キー変更: `0` のまま
   - フォルマント考慮: ✓ チェック
   - 「🚀 キー変更・変換を実行」

3. 出力:
   - `曲名_vocals_0_44kHz_v1.wav` が生成

---

## 📞 サポート

### ログ確認

エラーが発生した場合、ターミナルのログを確認してください。

### よくある質問（FAQ）

**Q. 処理にどのくらい時間がかかりますか？**
A. 曲の長さとCPU性能により異なります。3分の曲で約2分が目安です。

**Q. ボーカルとNo Vocalsを両方処理できますか？**
A. はい。Tab 2でファイルを選択し直して、複数回実行できます。

**Q. ファイル名を自動生成したくありません**
A. テキストボックスで自由に編集できます。「再調整」を押さなければ保存されます。

**Q. 48kHz以外のサンプルレートは対応していますか？**
A. 現在は44.1kHzと48kHzのみです。必要な場合は別途FFmpegコマンドで対応可能です。

---

## 📚 参考資料

- [Demucs GitHub](https://github.com/facebookresearch/demucs)
- [FFmpeg 公式](https://ffmpeg.org/)
- [Streamlit 公式](https://streamlit.io/)
- [ReadMe.md](ReadMe.md) - 技術的な実装ノート

---

## 📝 ライセンス

このプロジェクトは個人利用・技術検証目的です。  
**⚠️ 音源の著作権・利用条件に注意してください。**

本ツールで処理した音源は、著作権者の許可なく商用利用・配布することはできません。

---

**最終更新**: 2026年1月  
**バージョン**: 1.0
